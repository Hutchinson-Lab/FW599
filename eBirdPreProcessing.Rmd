---
title: "eBird Data Processing"
output: html_notebook
---

This document contains code to pre-process the eBird data.  

Set-up chunk.
```{r}
source("Y:/users/rah/R/Rconfigure_default.r")
library(ggplot2)
library(ggmap)
library(knitr)
library(sp)
library(raster)
library(ggcorrplot)
knitr::opts_knit$set(root.dir = "Y:/users/rah/Teaching/2018fa_fw599")
```

Here's some code to limit to our 10 focal species. This chunk is set up to not run - it's just here for completeness. It grabs the 2016 data, limits to the 10 species, and limits to January.
```{r,eval=FALSE}
sppNames = c('Anas_acuta', # Northern Pintail
             'Anas_fulvigula', # Mottled Duck
             'Aythya_valisineria', # Canvasback
             'Oxyura_jamaicensis', # Ruddy Duck 
             'Anas_americana', # American Wigeon
             'Bucephala_clangula', # Common Goldeneye
             'Melanitta_perspicillata', # Surf Scoter
             'Anas_strepera', # Gadwall
             'Aix_sponsa', # Wood Duck
             'Cygnus_columbianus') # Tundra Swan

df <- as.data.frame(matrix(0, ncol = 20, nrow = 3335078), stringsAsFactors = FALSE)

colNames <- names(read.csv("Y:/data/eBirdRef/ERD2016SS/2016/checklists.csv",nrow=1))
nCols = length(colNames)

colClasses = array("NULL",c(nCols,1))
colClasses[1:19] = NA # first 19 are checklist-specific
colClasses[which(is.element(colNames,sppNames))] = NA
system.time(duckData <- read.csv("Y:/data/eBirdRef/ERD2016SS/2016/checklists.csv",colClasses=colClasses))
# took a little over 2 hours to read all this in

janDuckData = subset(duckData,MONTH==1)

save(janDuckData,file="Y:/users/rah/Teaching/2018fa_fw599/janDuckData.RData")
```

Here's some code to limit to North America, excluding Hawaii. This chunk is set up not to run - it's just here for completeness.
```{r,eval=FALSE}
load("Y:/users/rah/Teaching/2018fa_fw599/janDuckData.RData")

countries = c("Anguilla", "Antigua and Barbuda", "Aruba", "Bahamas", "Barbados", "Canada", "Cayman Islands", "Cuba", "Cuba", "Dominican Republic", "Grenada", "Haiti", "Jamaica", "Martinique", "Mexico", "Montserrat", "Puerto Rico", "Saint Kitts and Nevis", "Saint Lucia", "Saint Martin (French part)", "Saint Pierre and Miquelon", "Saint Vincent and the Grenadines", "Turks and Caicos Islands", "United States", "United States Minor Outlying Islands", "Virgin Islands (British)", "Virgin Islands (U.S.)" )

janDuckData = subset(janDuckData,is.element(COUNTRY,countries)
& STATE_PROVINCE!="Hawaii")

duckData = janDuckData
save(duckData,file="Y:/users/rah/Teaching/2018fa_fw599/janDuckDataNAmer.RData")
```

Load the eBird data subset.
```{r}
load("Y:/users/rah/Teaching/2018fa_fw599/GroupProject/FW599/janDuckDataNAmer.RData") # duckData
```

# Decision: PRIMARY_CHECKLIST_FLAG
See section 4.2.1 of the eBird documentation (pdf on Canvas).
```{r}
table(duckData$PRIMARY_CHECKLIST_FLAG)
```
This takes the value 1 for unique checklists or for the primary checklist of a group count. Limit to PRIMARY_CHECKLIST_FLAG==1.

```{r}
duckData_v2 = duckData[which(duckData$PRIMARY_CHECKLIST_FLAG==1),]
dim(duckData)
dim(duckData_v2)
```

# Decision: COUNT_TYPE
Check out Table 2 in the eBird documentation.
```{r}
table(duckData_v2$COUNT_TYPE)
```

** Are there any count types we want to categorically exclude? ** If so, create v3 of the data here:
```{r}
duckData_v3 = duckData_v2
```


# Decision: EFFORT variables
```{r}
par(mfcol=c(1,3))
hist(duckData_v3$EFFORT_HRS, main="EFFORT_HRS") # applies to stationary counts
hist(duckData_v3$EFFORT_DISTANCE_KM, main="EFFORT_DISTANCE_KM") # applies to traveling counts
hist(duckData_v3$EFFORT_AREA_HA, main="EFFORT_AREA_HA") # applies to areal counts
par(mfcol=c(1,1))
```
Looks like there are some extreme values for distance and area! Closer look at the top 100 values:
```{r}
sort(duckData_v3$EFFORT_DISTANCE_KM,decreasing = TRUE)[1:100]
```
These values seem huge. For comparison, the WORLDCLIM data we're working with has a spatial resolution of about 340 km^2 (we can get higher resolution if desired). This corresponds to a circle with a radius of about 10km. One could imaging limiting traveling counts to at most 10km. How many is this?
```{r}
sum(duckData_v3$EFFORT_DISTANCE_KM<=10) # checklists covering at most 10km
dim(duckData_v3)[1] # total number of checklists
```
Not a huge reduction. Let's go for it.
```{r}
duckData_v4 = duckData_v3[which(duckData_v3$EFFORT_DISTANCE_KM<=10),]
```

A similar process for area counts would make sense.
```{r}
sort(duckData_v4$EFFORT_AREA_HA,decreasing = TRUE)[1:100]
```
```{r}
sum(duckData_v4$EFFORT_AREA_HA<=10) # checklists covering at most 10km
dim(duckData_v4)[1] # total number of checklists
```
```{r}
duckData_v5 = duckData_v4[which(duckData_v4$EFFORT_AREA_HA<=10),]
dim(duckData_v5)
```

** Should we limit the amount of hours spent as well? ** If so, create v6 here.
```{r}
duckData_v6 = duckData_v5
```

# Map the new version

```{r}
map = get_map(location=c(min(duckData_v6$LONGITUDE)-1,
                         min(duckData_v6$LATITUDE)-1,
                         max(duckData_v6$LONGITUDE)+1,
                         max(duckData_v6$LATITUDE)+1),
              maptype="satellite")
p = ggmap(map) 
p + geom_point(aes(x=LONGITUDE,y=LATITUDE,col="red"),data=duckData_v6)
```

Zoom in on Oregon.
```{r}
map = get_map(location=c(min(duckData_v6$LONGITUDE[duckData_v6$STATE_PROVINCE=="Oregon"])-1,                         min(duckData_v6$LATITUDE[duckData_v6$STATE_PROVINCE=="Oregon"])-1,                         max(duckData_v6$LONGITUDE[duckData_v6$STATE_PROVINCE=="Oregon"])+1,                         max(duckData_v6$LATITUDE[duckData_v6$STATE_PROVINCE=="Oregon"])+1),
              maptype="satellite")
p2 = ggmap(map) 
p2 + geom_point(aes(x=LONGITUDE,y=LATITUDE,col="red"),data=duckData_v6)
```

```{r}
save(duckData_v6,filename="Y:/users/rah/Teaching/2018fa_fw599/janDuckDataNAmer_v2.RData")
```

